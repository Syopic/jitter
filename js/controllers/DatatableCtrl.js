angular.module("sara").constant("XlsxPopulate",window.XlsxPopulate).run(["$rootScope",function(e){e.XlsxPopulate=window.XlsxPopulate}]).controller("DatatableCtrl",["$rootScope","$scope","$stateParams","$state","$uibModal","DTOptionsBuilder","DTColumnBuilder","ServiceData","DataFactory","toast",function(e,t,a,n,s,l,i,o,r,c){function u(e,a){var n=m[e],s=t.columns[e];n.options=l.newOptions().withFnServerData(a).withOption("serverSide",!0).withDOM("ftr").withBootstrap().withScroller().withOption("bFilter",!1).withOption("scrollX","100%").withOption("sortable",!1).withOption("bSort",!1).withOption("scrollY","HIV"==e?"calc(100vh - 470px)":"calc(100vh - 350px)").withOption("rowCallback",function(e,a,n,s){return $("td",e).unbind("click"),$("td",e).bind("click",function(){t.$apply(function(){t.edit(a)})}),e}),n.columns=[i.newColumn("name").notSortable().withOption("sWidth","200px")];for(var o=0;o<s.length;o++){var r=i.newColumn("indexes."+o+".value").notSortable();n.columns.push(r)}}function d(e){var t={name:"Total",indexes:[]},a=!1;if(e[0].indexes)for(var n=0;n<e[0].indexes.length;n++)t.indexes.push({code:e[0].indexes[n].code,value:0});for(var s=0;s<e.length;s++)if("Total"==e[s].name&&(a=!0),e[s].indexes&&"Total"!=e[s].name)for(n=0;n<e[s].indexes.length;n++)t.indexes[n].value+=Number(e[s].indexes[n].value);for(n=0;n<t.indexes.length;n++)t.indexes[n].value=Math.round(t.indexes[n].value/e[0].indexes.length*100)/100;return a?e[e.length-1]=t:e.push(t),e}function p(){d(t.regions[t.disease]),records={data:t.regions[t.disease]},t.callBack[t.disease](records)}function y(e){return f().then(function(a){var n=!0,s="<Disease>"!=a.sheet(0).cell("K1").value()?a.sheet(0).cell("K1").value():null,l=o.diseaseIndicatorsDirectory[s];if(n=null!=s){var i="A5:BF200";"HIV"==s?i="A6:BF200":"Malaria"==s?i="A5:AD200":"TB"==s&&(i="A5:X200");for(var r=(i=a.sheet(0).range(i)).cells(),u=0;u<r.length;u++){var d=i.cell(u,0).value();if(d&&"Total"!=d)for(var y={name:i.cell(u,0).value(),indexes:[]},f=0;f<l.length;f++)if(l[f]&&(y.indexes[f]={code:l[f].code,value:i.cell(u,f+1).value()?i.cell(u,f+1).value():""},y.indexes[f].value>100)){n=!1;break}}}if(n){t.continent="<Continent>"!=a.sheet(0).cell("U1").value()?a.sheet(0).cell("U1").value():t.continent,t.country="<Country Name>"!=a.sheet(0).cell("A1").value()?a.sheet(0).cell("A1").value():t.country,t.type="<HFA type>"!=a.sheet(0).cell("F1").value()?a.sheet(0).cell("F1").value():t.type,t.disease="<Disease>"!=a.sheet(0).cell("K1").value()?a.sheet(0).cell("K1").value():t.disease,t.year="<Year>"!=a.sheet(0).cell("P1").value()?a.sheet(0).cell("P1").value():t.year,t.selectedContinent=t.continents.filter(function(e){return e.name==t.continent})[0],t.selectedCountry=t.countries.filter(function(e){return e.name==t.country})[0],t.selectedHFAType=t.hfaTypes.filter(function(e){return e.name==t.type})[0],t.selectedDisease=t.disease,t.selectedYear=t.year+"",t.isSendingDataEnable=!0,t.statusText="Data changed",t.$apply(),h(!1);l=o.diseaseIndicatorsDirectory[t.disease],i="A5:BF200";"HIV"==t.disease?i="A6:BF200":"Malaria"==t.disease?i="A5:AD200":"TB"==t.disease&&(i="A5:X200");var m=a.sheet(0).range(i),g=m.cells(),v=[];for(u=0;u<g.length;u++){if(m.cell(u,0).value()){for(y={name:m.cell(u,0).value(),indexes:[]},f=0;f<l.length;f++)l[f]&&(y.indexes[f]={code:l[f].code,value:m.cell(u,f+1).value()?m.cell(u,f+1).value():""});v.push(y)}}return t.regions[t.disease]=v,c.pop({title:"Importing data",body:"Data for "+t.country+" has been successfully imported!",type:"success",showCloseButton:!0}),t.$apply(),p(),a.outputAsync(e)}return c.pop({title:"Error importing data",body:"Please check availability in the XLSX-file:<ul> <li>only numerical values</li><li>only digits from 0 to 100</li><li>format: &quot;&lt;integer&gt;&quot; or &quot;&lt;integer&gt;, &lt;two digits&gt;&quot;</li></ul>",bodyOutputType:"trustedHtml",type:"error",showCloseButton:!0}),t.statusText="Import error!",t.$apply(),null})}function f(){return t.currentFile=g.files[0],t.currentFile?XlsxPopulate.fromDataAsync(t.currentFile):t.currentTemplate?XlsxPopulate.fromDataAsync(t.currentTemplate):v.reject("You must select a file.")}function h(e){n.go("root.datatable",{continent:t.continent,country:t.country,disease:t.disease,type:t.type,year:t.year,mode:t.mode},{notify:e})}var m=this;t.continent=a.continent?a.continent:"Africa",t.country=a.country?a.country:"Kenya",t.disease=a.disease?a.disease:"HIV",t.type=a.type?a.type:"SARA",t.year=a.year?a.year:"2010",t.mode=a.mode?a.mode:1,t.years=o.collections.Years,t.selectedYear=t.year,t.selectedDisease=t.disease,t.selectedHFA=t.type,isUpdate=!1,h(!1),t.callBackFn=null,t.currentFile=null,t.currentTemplate=null,t.isSendingDataEnable=!1,t.isPendinggData=!1,t.callBack={},t.statusText="",t.selectedContinent=null,t.selectedCountry=null,t.selectedHFAType=null,t.selectedDisease=t.disease,t.selectedYear=t.year,t.continents=[],t.countries=[],t.hfaTypes=[],t.diseases=o.collections.Diseases,t.years=o.collections.Years,t.regions={},t.regions.HIV=[],t.regions.TB=[],m.HIV={},m.TB={},m.Malaria={},m.HIV.dtInstance={},m.TB.dtInstance={},m.Malaria.dtInstance={},t.fileChosen=!1;var g=document.getElementById("fileInput"),v=XlsxPopulate.Promise;t.headers={},t.columns={},t.headers.HIVL0=o.complexHeaders.HIVL0,t.headers.HIV=o.complexHeaders.HIV,t.headers.TB=o.complexHeaders.TB,t.headers.Malaria=o.complexHeaders.Malaria,t.columns.HIV=o.diseaseIndicatorsDirectory.HIV,t.columns.TB=o.diseaseIndicatorsDirectory.TB,t.columns.Malaria=o.diseaseIndicatorsDirectory.Malaria,t.getData=function(e,a,n,s){a[0].value;var l={disease:t.disease,type:t.type,country:t.country,year:t.year};t.statusText="Pending data ...",t.isPendinggData=!0,r.getRegions(l).then(function(e){e.data.result?(d(e.data.data.regions),t.regions[t.disease]=e.data.data.regions,t.statusText="Done",records={data:t.regions[t.disease]},n(records)):t.statusText=e.data.message,t.isPendinggData=!1})},t.getDataHIV=function(e,a,n,s){t.callBack.HIV=n,"HIV"==t.disease&&t.getData(e,a,n,s)},t.getDataTB=function(e,a,n,s){t.callBack.TB=n,"TB"==t.disease&&t.getData(e,a,n,s)},t.getDataMalaria=function(e,a,n,s){t.callBack.Malaria=n,"Malaria"==t.disease&&t.getData(e,a,n,s)},u("HIV",t.getDataHIV),u("TB",t.getDataTB),u("Malaria",t.getDataMalaria),t.edit=function(e){var a=e,n=1==t.mode,l=t.columns[t.disease];if("Total"!=a.name){s.open({animation:!1,ariaLabelledBy:"modal-title-top",ariaDescribedBy:"modal-body-top",templateUrl:"views/editPopup.html",size:"md",controller:function(e,t){e.isEditable=n,e.name=a.name,e.data=a;for(var s=[],i=0;i<l.length;i++)s.push({param:l[i].name,code:l[i].code,value:a.indexes[i].value});e.params=s,e.save=function(){if(e.isEditable){for(var a=0;a<e.data.indexes.length;a++)e.data.indexes[a]={code:l[a].code,value:e.params[a].value};t.close(e.data)}},e.close=function(){t.dismiss("cancel")}},resolve:{items:function(){return t.items}}}).result.then(function(e){t.isSendingDataEnable=!0,t.statusText="Data changed",p()},function(){console.log("Modal dismissed")})}},t.populateTable=function(){return y().then(function(e){}).catch(function(e){throw c.pop({title:"Upload file warning",body:e.message||e,type:"warning",showCloseButton:!0}),t.$apply(),e})},t.generateBlob=function(){return t.currentFile?t.createObject():r.getTemplate(t.disease).then(function(e){return t.currentTemplate=e.data,t.createObject()})},t.createObject=function(){return function(e){return f().then(function(a){var n="A5:BF200";"HIV"==t.disease?n="A6:BF200":"Malaria"==t.disease?n="A5:AD200":"TB"==t.disease&&(n="A5:X200");var s=a.sheet(0).range(n);a.sheet(0).cell("U1").value(t.continent),a.sheet(0).cell("A1").value(t.country),a.sheet(0).cell("F1").value(t.type),a.sheet(0).cell("K1").value(t.disease),a.sheet(0).cell("P1").value(t.year),s.cells();for(var l=0;l<t.regions[t.disease].length;l++)if(t.regions[t.disease][l].name){s.cell(l,0).value(t.regions[t.disease][l].name);for(var i=0;i<t.columns[t.disease].length;i++)s.cell(l,i+1).value(t.regions[t.disease][l].indexes[i].value)}return a.outputAsync(e)})}().then(function(e){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t.currentFile.name);else{var a=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.href=a,n.download=t.country+"_"+t.disease+"_"+t.type+"_"+t.year+".xlsx",n.click(),window.URL.revokeObjectURL(a),document.body.removeChild(n)}}).catch(function(e){throw c.pop({title:"Upload file warning",body:e.message||e,type:"warning",showCloseButton:!0}),t.$apply(),e})},t.sendData=function(){var e={data:{year:t.year,nameDisease:t.disease,nameHFAType:t.type,nameCountry:t.country,regions:t.regions[t.disease]}};t.isSendingDataEnable=!1,t.statusText="Sending data to server ...",r.postRegions(e).then(function(e){t.statusText="All data saved"})},t.uploadChange=function(){t.populateTable(),t.fileChosen=!0},r.getContinents().then(function(e){t.continents=e.data.continents,t.selectedContinent=t.continents.filter(function(e){return e.name==t.continent})[0]}),r.getHFATypes().then(function(e){t.hfaTypes=e.data.hfaTypes,t.selectedHFAType=t.hfaTypes.filter(function(e){return e.name==t.type})[0]}),t.$watch("selectedContinent",function(){t.selectedContinent&&r.getCountries(t.selectedContinent.name).then(function(e){t.countries=e.data.countries,t.selectedCountry=t.countries.filter(function(e){return e.name==t.country})[0],t.selectedCountry||(t.selectedCountry=t.countries[0])})}),t.applyForm=function(){t.continent=t.selectedContinent.name,t.country=t.selectedCountry.name,t.type=t.selectedHFAType.name,t.disease=t.selectedDisease,t.year=t.selectedYear,t.isSendingDataEnable=!1,h(!0)}}]);