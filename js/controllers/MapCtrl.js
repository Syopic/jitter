angular.module("sara").controller("MapCtrl",["$scope","$timeout","ServiceData","$window","$interval",function(e,t,a,n,o){function i(e,t){y[e.properties.name]=t,t.on({mouseover:r,mouseout:c})}function r(t){l(t.target,t.target==e.selectedLayer)}function l(e,t){e&&(e.setStyle({color:"#ff8b46",weight:3,opacity:t?1:0,fillOpacity:t?.8:.5}),g.update(e.feature),!t||L.Browser.ie||L.Browser.opera||L.Browser.edge||e.bringToFront())}function c(t){var a=t.target;e.selectedLayer&&e.selectedLayer==a?(l(e.selectedLayer,!0),g.update(e.selectedLayer.feature)):(geojson.resetStyle(t.target),g.update(),e.selectedLayer&&(l(e.selectedLayer,!0),g.update(e.selectedLayer.feature)))}function s(){f.fitBounds([[p[1],p[0]],[p[3],p[2]]]);var t=1/0,n=-1/0;e.cGrades=[],angular.forEach(e.mapData,function(e,a){t=Math.min(t,e.value),n=Math.max(n,e.value)});for(var o=(n-t)/5,i=0;i<5;i++)e.cGrades[i]={value:i*o+t,color:a.gColors[i]};geojson.setStyle(d)}function d(t){var n=0;return e.mapData&&(n=e.mapData.filter(function(e){return e.name==t.properties.name})[0])&&(n=n.value),{color:"#fff",weight:2,fillColor:a.getColor(e.cGrades,Number(n)),fill:!0,opacity:1,fillOpacity:.8}}function u(){if(e.selectedIndicator){var t=e.ind.filter(function(t){return t.name==e.selectedIndicator.name})[0];e.mapData=[],angular.forEach(e.Data.regions,function(a,n){null==a.indexes[t.index].value?e.mapData.push(0):e.mapData.push({name:a.name,value:Number(a.indexes[t.index].value)})}),e.mapData.length&&s()}}e.cGrades=[],e.isMapVisible=!0;var p=[],f=L.map("map",{doubleClickZoom:!1,tap:!1});f.scrollWheelZoom.disable();var m=L.tileLayer("https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(f),g=L.control({position:"topright"});g.onAdd=function(e){return this._div=L.DomUtil.create("div","mapinfo"),this.update(),this._div},g.update=function(t){if(t){var a=function(t){var a=e.mapData.filter(function(e){return e.name==t})[0];return a?a.value:"-"}(t.properties.name);this._div.innerHTML="<h4><b>"+t.properties.name+"</b></h4><h4>"+e.selectedIndicator.name+": "+("-"==a?"data not available":a+"%")+"</h4><br>"}else this._div.innerHTML="<h4>"+e.selectedIndicator.name+"</h4>"},g.addTo(f),m.setOpacity(.2);L.control({position:"topright"});var y=[];e.selectedLayer=null,function(a){t(function(){$.getJSON("data/geojson/"+a+".json",function(e){geojson=L.geoJson(e,{clickable:!0,style:d,onEachFeature:i}).addTo(f),p=e.bounds,s(e.bounds)}).done(function(){e.isMapVisible=!0}).fail(function(){e.isMapVisible=!1,console.log("MAp for this countri is not avaliable")})})}(e.country),angular.element(n).bind("resize",function(){o(s,500,1)}),e.$watch("selectedIndicator",function(){u(),e.selectedLayer=null,e.selectedLayer?g.update(e.selectedLayer.feature):g.update(),e.elementLegend=a.getLegend(e.disease,e.selectedIndicator.index),e.mapLegend="["+e.selectedIndicator.code+"] "+e.elementLegend+" "+e.selectedIndicator.name}),e.$watch("selectedRegion",function(){e.selectedLayer&&(geojson.resetStyle(e.selectedLayer),g.update());e.mapData.filter(function(t){return t.name==e.selectedRegion})[0];e.selectedLayer=y[e.selectedRegion],e.selectedLayer&&(l(e.selectedLayer,!0),g.update(e.selectedLayer.feature))}),e.$watch("Data.regions",function(){u()}),e.multiselectModelMap=[],e.multiselectSettingsMap={showCheckAll:!1,styleActive:!1,buttonClasses:"btn btn-info ",selectionLimit:1,template:'{{"["+option.code+"] " + option.name}}',scrollableHeight:"300px",scrollable:!0,closeOnSelect:!0,groupByTextProvider:function(t){return a.getLegendByGroup(e.disease,t)},groupBy:"group"},e.multiselectEventsMap={onItemSelect:function(t){e.selectedIndicator=e.multiselectModelMap[0]},onItemDeselect:function(t){e.selectedIndicator=e.ind[0]},onDeselectAll:function(){e.selectedIndicator=e.ind[0]}}}]);