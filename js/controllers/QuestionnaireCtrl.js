angular.module("sara").constant("XlsxPopulate",window.XlsxPopulate).run(["$rootScope",function(e){e.XlsxPopulate=window.XlsxPopulate}]).controller("QuestionnaireCtrl",["$q","$stateParams","$timeout","HIV","TB","Malaria","$uibModal","$rootScope","$scope","$compile","DTOptionsBuilder","DTColumnBuilder","ServiceData","DataFactory",function(e,n,t,o,a,r,l,i,s,c,u,d,m,p){function h(){records={draw:s.draw,data:s.regions},s.callBackFn(records)}function w(){return s.currentFile=v.files[0],s.currentFile?XlsxPopulate.fromDataAsync(s.currentFile):g.reject("You must select a file.")}var f=this;s.disease=n.disease?n.disease:"HIV",s.regions=[],s.draw=null,s.callBackFn=null,s.currentFile=null,s.fileChosen=!1;var v=document.getElementById("fileInput"),g=XlsxPopulate.Promise;s.getData=function(e,n,t,o){var a=n[0].value;s.callBackFn?h():p.getRegionsData(s.disease).then(function(e){var n=[],o=e.data.data.regions;for(var r in o){for(var l={name:r},i=o[r],c=0;c<i.length;c++)for(var u in i[c])l[u]=i[c][u]?i[c][u]:Math.round(1e3*Math.random());n.push(l)}s.regions=n,s.draw=a,s.callBackFn=t,records={draw:a,recordsTotal:s.regions.length,data:s.regions},t(records),document.getElementById("datatable_info").style.display="none"})},s.edit=function(e){var n=s.columns;l.open({animation:!1,ariaLabelledBy:"modal-title-top",ariaDescribedBy:"modal-body-top",templateUrl:"views/editPopup.html",size:"md",controller:function(e){for(var t=[],o=0;o<n.length;o++)t.push({param:n[o].name,value:45});e.params=t}})},s.populateTable=function(){return function(e){return w().then(function(n){var t=n.sheet(0).range("A5:BF51"),o=n.sheet(0).cell("A1").value(),a=t.cells();console.log(o);for(var r=[],l=0;l<a.length;l++){for(var i={name:t.cell(l,0).value()},c=0;c<s.columns.length;c++)s.columns[c]&&(i[s.columns[c].code]=t.cell(l,c+1).value()?t.cell(l,c+1).value():0);r.push(i)}return s.regions=r,h(),n.outputAsync(e)})}().then(function(e){}).catch(function(e){throw alert(e.message||e),e})},s.generateBlob=function(){return function(e){return w().then(function(n){return n.sheet(0).cell("A1").value("This was created in the browser!").style("fontColor","ff0000"),n.outputAsync(e)})}().then(function(e){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,s.currentFile.name);else{var n=window.URL.createObjectURL(e),t=document.createElement("a");document.body.appendChild(t),t.href=n,t.download=s.currentFile.name,t.click(),window.URL.revokeObjectURL(n),document.body.removeChild(t)}}).catch(function(e){throw alert(e.message||e),e})},function(){s.headers=m.complexHeaders[s.disease],"HIV"==s.disease&&(s.headersL0=m.complexHeaders.HIVL0),s.columns=m.diseaseIndicatorsDirectory[s.disease],f.columns=[d.newColumn("name")];for(var e=0;e<s.columns.length;e++){var n=d.newColumn(s.columns[e].code);f.columns.push(n)}f.options=u.newOptions().withFnServerData(s.getData).withDataProp("data").withOption("serverSide",!0).withDOM('<"row"<"col-sm-6"i><"col-sm-6"f>><"table-responsive"tr><"row"<"col-sm-6"l><"col-sm-6"p>>').withBootstrap().withOption("bFilter",!1).withOption("bProcessing",!1).withOption("scrollX","100%").withScroller().withOption("scrollY","calc(100vh - 450px)").withOption("rowCallback",function(e,n,t,o){return e})}(),s.uploadChange=function(){s.populateTable(),s.fileChosen=!0}}]);